---
import path from 'node:path';
import { readdir, readFile } from 'node:fs/promises';
import { fileURLToPath } from 'node:url';
import YAML from 'yaml';
import type { Recipe } from '../../types/schema';
import { resolveRawBase } from '../../utils/git';

type RecipeProps = {
  data: Recipe;
  url: string;
};

export async function getStaticPaths() {
  const recipesDir = fileURLToPath(new URL('../../../../recipes/', import.meta.url));
  const entries = await readdir(recipesDir, { withFileTypes: true });
  const repoRoot = path.resolve(recipesDir, '..');
  const rawBaseUrl = await resolveRawBase(repoRoot, 'recipes');
  const paths = await Promise.all(
    entries
      .filter((entry) => entry.isFile() && /\.recipe\.ya?ml$/i.test(entry.name))
      .map(async (entry) => {
        const slug = entry.name.replace(/\.recipe\.ya?ml$/i, '');
        const content = await readFile(path.join(recipesDir, entry.name), 'utf-8');
        const data = YAML.parse(content) as Recipe;
        return {
          params: { slug },
          props: { data, url: `${rawBaseUrl}${entry.name}` },
        };
      }),
  );

  return paths;
}

const { data, url } = Astro.props as RecipeProps;

const recipeRecord = data as Record<string, unknown>;
const title =
  typeof recipeRecord.name === 'string' && recipeRecord.name.length > 0
    ? (recipeRecord.name as string)
    : 'Recipe';
const description =
  typeof recipeRecord.description === 'string' ? (recipeRecord.description as string) : '';
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>{title}</title>
    {description && <meta name="description" content={description} />}
  </head>
  <body>
    <p>
      <a href={url}>View raw recipe file</a>
    </p>
    <pre>{JSON.stringify(data, null, 2)}</pre>
  </body>
</html>
